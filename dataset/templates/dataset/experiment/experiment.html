{% extends "dataset/base/base.html" %}
{% load dataset_tags %}
{% load licence_tags %}

{% block target %}
  <h2 id="targets" class="underline left-align section-heading"> Targets </h2>
  {% visible_children instance user as visible_scoresets %}
  
  {% if visible_scoresets|length %}
    {% if visible_scoresets|length > 1%}
      <p class="text-muted">Multiple targets have been scored for this experiment: </p>
    {% else %}
      <p class="text-muted">A single target has been scored for this experiment: </p>
    {% endif %}

    {% organise_by_target visible_scoresets as children_by_target %}
    {% for gene, children in children_by_target.items %}
      <h5>{{ gene|upper }}</h5>
      {% for child in children %}
        <div class="target-card" data-toggle="popover" title="<b>{{ child.urn }}</b><hr>{{ child.get_title }}"
             data-content="{{ child.get_description }}" data-placement=auto
             onmouseover="$(this).popover({trigger:'hover', html:true});"
             style="cursor: help; margin-bottom: 1rem; margin-top: 1rem" >

          <a href={% url 'dataset:scoreset_detail' child.urn %}>
            <p class="urn-item-link">{{ child.urn }} {% if child.private %}[Private]{% endif %}</p>
          </a>

          <div style="padding-left: 1em; border-left: 1px solid #987cb8;">
            <p>
              <strong>Target type: </strong>
              <a href="/search/?target_type={{ child.get_target.category }}">
                {{ child.get_target.category }}
              </a>
            </p>

            <p>
              <strong>Organism: </strong>
              <a href="/search/?organism={{ child.get_target.get_reference_genomes.first.get_organism_name }}">
                {{ child.get_target.get_reference_genomes.first.format_organism_name_html|safe }}
              </a>
            </p>

            <p>
              <strong>Reference genome: </strong>
              <a href="/search/?genome={{ child.get_target.get_reference_genomes.first.get_short_name }}">
                {{ child.get_target.get_reference_genomes.first.get_short_name }}
              </a>
            </p>

            <p>
              <strong>Reference assembly: </strong>
              {% if child.get_target.get_reference_genomes.first.genome_id.identifier %}
                <a target="_blank" href={{ child.get_target.get_reference_genomes.first.genome_id.url }}>
                  {{ child.get_target.get_reference_genomes.first.genome_id.identifier }}
                  <i class="external-link fas fa-external-link-alt"></i>
                </a>
              {% else %}
                Other/Synthetic
              {% endif %}
            </p>

            <p class="wild-type-sequence">
              <strong>Reference sequence: </strong>
              {{ child.get_target.get_wt_sequence }}
            </p>
          </div>
        </div>
        {% if forloop.counter < children|length %}
          <hr style="width: 99%">
        {% endif %}
      {% endfor %}
      {% if forloop.counter < children_by_target.items|length %}
        <hr style="width: 99%">
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted">No targets have been scored for this experiment.</p>
  {% endif %}
{% endblock %}

{% block child_list %}
  {% visible_children instance user as visible_scoresets %}
  <span>
    <h2 id='scoresets' class="underline left-align section-heading">Score sets
      {% if request.user in instance.editors or request.user in instance.administrators %}
        <a href="{% url 'dataset:scoreset_new' %}?experiment={{ instance.urn }}">
          <i class="icon fa fa-plus pl-1" data-toggle="tooltip" data-placement="top" title="Add a score set."
             style="font-size: 28px; padding-bottom: 8px"></i>
        </a>
      {% endif %}
    </h2>
  </span>
  {% if visible_scoresets|length %}
    <ul>
      {% for child in visible_scoresets %}
        <li class="child-list-item">
          <a style="display:block;" href="{% url 'dataset:scoreset_detail' child.urn %}">
            <p class="urn-item-link">{{ child.urn }} {% if child.private %}[Private]{% endif %}</p>
          </a>
          <p class="child-list-description"><b>{{ child.get_title }}</b></p>
          <p class="child-list-description">{{ child.get_description }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">No Score sets have been associated with this experiment.</p>
  {% endif %}
{% endblock %}

